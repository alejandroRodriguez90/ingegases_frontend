<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="admin-dashboard.css"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Librería Chart.js para gráficas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"><!-- Iconos de FontAwesome -->
    
</head>

<body>
    <!-- Barra superior -->
    <div class="top-bar">
        <div class="logo"><!-- Logo o foto de usuario -->
            <img src="imagenes /PHOTO-2025-01-22-08-45-11.jpg" alt="">
        </div>
        <div class="logout">   <!-- Botón de cerrar sesión -->
            <button onclick="window.location.href='../login/login.html'">Cerrar sesión</button>
        </div>
    </div>
    <div class="sidebar"><!-- Barra lateral vertical -->
        <ul>
            <li>
                <a href="#" id="controlInventarioLink">
                    <i class="fas fa-boxes icon"></i>
                    <span class="text">Control de Inventario</span>
                </a>
                    <ul class="submenu">
                        <li>
                            <a href="#" onclick="loadTuberia()">
                                <i class="fas fa-wrench icon"></i>
                                <span class="text">Tubería</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="loadAccesorios()">
                                <i class="fas fa-tools icon"></i>
                                <span class="text">Accesorios</span>
                            </a>
                        </li>
                    </ul>
                </a>
            </li>
            <li>
                <a href="#" id="proyectosLink">
                    <i class="fas fa-project-diagram icon"></i>
                    <span class="text">Proyecto</span>
                </a>
            </li>
            <li>
                <a href="#" id="requisicionLink">
                    <i class="fas fa-file-alt icon"></i>
                    <span class="text">Requisición</span>
                </a>
            </li>
            <li>
                <a href="#" id="proveedoresLink">
                    <i class="fas fa-truck icon"></i>
                    <span class="text">Proveedores</span>
                </a>
            </li>
            <li>
                <a href="#" id="almacenLink">
                    <i class="fas fa-warehouse icon"></i>
                    <span class="text">Almacén</span>
                </a>
            </li>
            <li>
                <a href="#" id="soporteLink">
                    <i class="fas fa-headset icon"></i>
                    <span class="text">Soporte</span>
                </a>
            </li>
        </ul>
    </div>

    
    <!-- Contenido principal -->
    <div class="main-content">
        <h1>Ingegases Y Redes s.a.s</h1>
        <div id="dynamicContent"></div><!-- Contenedor para contenido dinámico -->
    </div>

    
    <!-- Ventana modal PROYECTOS -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2 id="modalTitle">Título del Proyecto</h2> <!-- Título dinámico -->
            <form id="projectForm">
                <!-- Campos del formulario -->
                <label for="projectId">ID:</label>
                <input type="text" id="projectId" name="projectId" required>

                <label for="projectName">Proyecto:</label>
                <input type="text" id="projectName" name="projectName" required>

                <label for="projectDescription">Descripción:</label>
                <textarea id="projectDescription" name="projectDescription" required></textarea>

                <label for="projectLocation">Ubicación:</label>
                <input type="text" id="projectLocation" name="projectLocation" required>

                <label for="projectStartDate">Fecha de Inicio:</label>
                <input type="date" id="projectStartDate" name="projectStartDate" required>

                <label for="projectEndDate">Fecha de Fin:</label>
                <input type="date" id="projectEndDate" name="projectEndDate" required>

                <label for="projectManager">Encargado:</label>
                <select id="projectManager" name="projectManager" required>
                    <option value="Ing Alexander Herrera">Ing Alexander Herrera</option>
                    <option value="Ing Javier Sierra">Ing Javier Sierra</option>
                    <option value="Ing Daniel Buitrago">Ing Daniel Buitrago</option>
                    <option value="Ing Javier Penagos">Ing Javier Penagos</option>
                    <option value="Ing Nicolás Saavedra">Ing Nicolás Saavedra</option>
                    <option value="Ing Jenny Chaparro">Ing Jenny Chaparro</option>
                    <option value="Ing Melissa Gonzalez">Ing Melissa Gonzalez</option>
                </select>

                <label for="projectStatus">Estado:</label>
                <select id="projectStatus" name="projectStatus" required>
                    <option value="Asignado">Asignado</option>
                    <option value="En Ejecución">En Ejecución</option>
                    <option value="Realizado">Realizado</option>
                    <option value="Facturado">Facturado</option>
                    <option value="Anulado">Anulado</option>
                </select>

                <label for="projectBudget">Presupuesto:</label>
                <input type="text" id="projectBudget" name="projectBudget" required>

                <button type="submit" id="saveButton">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Ventana modal de confirmación para eliminar un proyecto -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>¿Realmente quieres eliminar el proyecto?</h2>
            <button id="confirmDelete">Sí</button>
            <button id="cancelDelete">No</button>
        </div>
    </div>


    <!-- Contenido dinámico ALMACEN-->
    <div id="dynamicContent" class="alm-content-container"></div>

    <!-- Modal de Almacén -->
    <div class="alm-modal-container" id="almacenModal">
    <div class="alm-modal-overlay" onclick="closeAlmModal('almacenModal')"></div>
    <div class="alm-modal-dialog alm-modal-lg">
        <div class="alm-modal-content">
        <div class="alm-modal-header">
            <h2 class="alm-modal-title">Detalles del Almacén</h2>
            <button class="alm-modal-close" onclick="closeAlmModal('almacenModal')">
            <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="alm-modal-body" id="almacenModalBody"></div>
        <div class="alm-modal-footer">
            <button class="alm-btn alm-btn-secondary" onclick="closeAlmModal('almacenModal')">
            <i class="fas fa-times"></i> Cerrar
            </button>
            <button class="alm-btn alm-btn-primary" onclick="exportarInventario()">
            <i class="fas fa-file-export"></i> Exportar
            </button>
        </div>
        </div>
    </div>
    </div>

    <!-- Modal para Agregar Producto -->
    <div class="alm-modal-container" id="agregarProductoModal">
    <div class="alm-modal-overlay" onclick="closeAlmModal('agregarProductoModal')"></div>
    <div class="alm-modal-dialog">
        <div class="alm-modal-content">
        <div class="alm-modal-header">
            <h2 class="alm-modal-title">Agregar Producto</h2>
            <button class="alm-modal-close" onclick="closeAlmModal('agregarProductoModal')">
            <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="alm-modal-body">
            <form id="alm-productoForm" class="alm-form-grid">
            <!-- Campos del formulario se generarán dinámicamente -->
            </form>
        </div>
        <div class="alm-modal-footer">
            <button class="alm-btn alm-btn-secondary" onclick="closeAlmModal('agregarProductoModal')">
            <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="alm-btn alm-btn-primary" onclick="guardarNuevoProducto()">
            <i class="fas fa-save"></i> Guardar
            </button>
        </div>
        </div>
    </div>
    </div>

    <script>
            

        // ==========================================================================
        // INVENTARIO TUBERIA 
        // ==========================================================================

        const materialOptions = {
            "Cobre": { tipos: ["M", "K", "L"], diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "3", "3-1/2", "4"] },
            "Acero inoxidable": { tipos: ["10", "40", "80"], diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "3", "3-1/2", "4"] },
            "Acero carbono": { tipos: ["10", "40", "80"], diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "3", "3-1/2", "4"] },
            "PVC": { tipos: ["Presion", "Electrica", "Sanitaria", "Ventilacion"], diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "3", "3-1/2", "4"] }
        };

        // Generar mapeo de descripciones a códigos
        let codigoCounter = 1;
        const descripcionToCodigo = {};
        const descripcionesDisponibles = [];
        for (const material in materialOptions) {
            const tipos = materialOptions[material].tipos;
            const materialSinEspacios = material.replace(/\s+/g, '');
        
            for (const tipo of tipos) {
                // Formatear el tipo según las reglas:
                let tipoFormateado = tipo;
                if (["M", "K", "L"].includes(tipo)) {
                    tipoFormateado = `Tipo${tipo}`;  // Ej: TipoM, TipoK, TipoL
                } else if (["10", "40", "80"].includes(tipo)) {
                    tipoFormateado = `Sch${tipo}`;   // Ej: Sch10, Sch40, Sch80
                }
                // Los demás tipos (ej: "Presión") se quedan igual
        
                for (const diametro of materialOptions[material].diametros) {
                    const descripcion = `Tubería${materialSinEspacios}${tipoFormateado}${diametro}`;
                    const codigo = "IYR" + codigoCounter.toString().padStart(4, '0');
        
                    descripcionToCodigo[descripcion] = codigo;
                    descripcionesDisponibles.push(descripcion);
                    codigoCounter++;
                }
            }
        }


        // Variable para almacenar el item actual
        let itemActual = null;
        let chart;

        // ---------------------------------------------------------------------------
        // Funciones principales
        // ---------------------------------------------------------------------------
        function loadTuberia() {
            const tableContent = `
                <div class="section-title vertical-title">Tubería</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descripción</th>
                                <th>Ubicación</th>
                                <th>Cantidad</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generarFilaConsulta()}
                        </tbody>
                    </table>
                    <div class="export-button-container">
                        <button id="btnExportar">Exportar a Excel</button>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Gráfica de Consulta</h3>
                    <canvas id="tuberiaChart"></canvas>
                </div>
            `;

            document.getElementById('dynamicContent').innerHTML = tableContent;

            // Configurar eventos
            configurarEventos();
            
            // Inicializar gráfica (oculta al inicio)
            document.getElementById('tuberiaChart').style.display = 'none';
        }

        function generarFilaConsulta() {
            return `
                <tr class="fila-consulta">
                    <td id="codigoGenerado"></td>
                    <td>
                        <input type="text" id="inputDescripcion" 
                            placeholder="Buscar tubería..." 
                            list="listaTuberias" autocomplete="off">
                        <datalist id="listaTuberias">
                            ${descripcionesDisponibles.map(desc => 
                                `<option value="${desc}">${desc}</option>`).join('')}
                        </datalist>
                    </td>
                    <td><input type="text" id="inputUbicacion" placeholder="Ubicación" value="Bogotá"></td>
                    <td id="cantidadCell"><input type="number" id="inputCantidad" placeholder="Cantidad" min="0" value="0" onchange="actualizarEstadoStock()"></td>
                    <td><input type="number" id="inputValor" placeholder="Valor" min="0" step="0.01"></td>
                </tr>
            `;
        }

        function actualizarEstadoStock() {
            const cantidadInput = document.getElementById('inputCantidad');
            const cantidadCell = document.getElementById('cantidadCell');
            const valor = parseFloat(cantidadInput.value) || 0;
            
            if (valor === 0) {
                cantidadCell.innerHTML = `
                    <span class="no-stock" onclick="restaurarInputCantidad()">No Stock</span>
                    <input type="number" id="inputCantidad" value="0" min="0" style="display:none;">
                `;
            } else {
                cantidadCell.innerHTML = `<input type="number" id="inputCantidad" placeholder="Cantidad" min="0" value="${valor}" onchange="actualizarEstadoStock()">`;
            }
            
            // Actualizar el objeto itemActual si existe
            if (itemActual) {
                itemActual.cantidad = valor;
                actualizarGrafica();
            }
        }

        function restaurarInputCantidad() {
            const cantidadCell = document.getElementById('cantidadCell');
            cantidadCell.innerHTML = `<input type="number" id="inputCantidad" placeholder="Cantidad" min="0" value="0" onchange="actualizarEstadoStock()">`;
            document.getElementById('inputCantidad').focus();
        }


        function configurarEventos() {
            const inputDesc = document.getElementById('inputDescripcion');
            
            inputDesc.addEventListener('input', function() {
                // Restaurar el input de cantidad al cambiar descripción
                const cantidadCell = document.getElementById('cantidadCell');
                cantidadCell.innerHTML = `<input type="number" id="inputCantidad" placeholder="Cantidad" min="0" value="0" onchange="actualizarEstadoStock()">`;
                
                const descripcion = this.value;
                const codigo = descripcionToCodigo[descripcion];
                document.getElementById('codigoGenerado').textContent = codigo || '';
                
                if (codigo) {
                    itemActual = {
                        codigo: codigo,
                        descripcion: descripcion,
                        ubicacion: document.getElementById('inputUbicacion').value || 'Bogotá',
                        cantidad: 0, // Iniciar en 0
                        valor: parseFloat(document.getElementById('inputValor').value) || 0
                    };
                    actualizarGrafica();
                }
            });
    
            // Actualizar datos cuando cambian otros campos
            ['inputUbicacion', 'inputValor'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (itemActual) {
                        itemActual.ubicacion = document.getElementById('inputUbicacion').value;
                        itemActual.valor = parseFloat(document.getElementById('inputValor').value) || 0;
                        actualizarGrafica();
                    }
                });
            });
            
            // Configurar botón de exportar
            document.getElementById('btnExportar').addEventListener('click', exportarAExcel);
            
            // Verificar estado inicial del stock
            actualizarEstadoStock();
        }

        function actualizarGrafica() {
            if (!itemActual) {
                document.getElementById('tuberiaChart').style.display = 'none';
                return;
            }
            
            const ctx = document.getElementById('tuberiaChart').getContext('2d');
            ctx.canvas.style.display = 'block';
            
            // Asegurar que el canvas tenga el tamaño correcto
            ctx.canvas.width = ctx.canvas.offsetWidth;
            ctx.canvas.height = 300; // Altura fija
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [itemActual.descripcion],
                    datasets: [{
                        label: 'Cantidad',
                        data: [itemActual.cantidad],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false, // Desactivar relación de aspecto fija
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Mostrar números enteros
                            }
                        },
                        y: { 
                            ticks: { 
                                autoSkip: false,
                                font: {
                                    size: 12 // Tamaño de fuente más pequeño
                                }
                            } 
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: () => {
                                    return `Código: ${itemActual.codigo}\nValor: $${itemActual.valor.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    }
                }
            });
        }

        function exportarAExcel() {
            if (!itemActual) {
                alert("No hay datos para exportar");
                return;
            }
            
            // Obtener el valor de cantidad (puede estar oculto como "No Stock")
            const cantidadInput = document.getElementById('inputCantidad');
            const cantidad = parseFloat(cantidadInput.value) || 0;
            
            // Crear un objeto con los datos a exportar
            const datos = [{
                'Código': itemActual.codigo,
                'Descripción': itemActual.descripcion,
                'Ubicación': itemActual.ubicacion || 'Bogotá', // Bogotá por defecto
                'Cantidad': cantidad === 0 ? 'No Stock' : cantidad, // Mostrar "No Stock" si es 0
                'Valor': itemActual.valor
                            
                }
            ];
            
            // Convertir a CSV
            const csvRows = [];
            const headers = Object.keys(datos[0]);
            csvRows.push(headers.join(','));
            
            for (const row of datos) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // Crear enlace de descarga
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `tuberia_${itemActual.codigo}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', loadTuberia);

        // ================================================================================
        // INVENTARIO ACCESORIOS
        // ================================================================================


        const materialOptionsAccesorios = {
            "Cobre": {
                tipos: ["Union", "Tee", "Tee Red Central", "Tee Red Lateral", "Codo", "Semicodo", "Copa Reduccion", "Universales", "Tapon", "Adaptador"],
                clases: ["M", "K", "L"],
                diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "2", "2-1/2", "3", "3-1/2", "4"],
                conexiones: ["Soldeo", "NPTH", "NPTM"],
                c_entradas: ["NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo"],
                c_salidas: ["NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo"]
            },
            "Acero Inoxidable": {
                tipos: ["Union", "Tee", "Tee Red Central", "Tee Red Lateral", "Codo", "Semicodo", "Copa Reduccion", "Universales", "Tapon", "Adaptador", "Bushing", "Brida"],
                clases: ["10", "40", "80"],
                diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "2", "2-1/2", "3", "3-1/2", "4"],
                conexiones: ["Soldeo", "NPTH", "NPTM", "Socket"],
                c_entradas: ["NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo", "Socket"],
                c_salidas: ["NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo", "Socket"]
            },
            "Acero Carbon": {
                tipos: ["Union", "Tee", "Tee Red Central", "Tee Red Lateral", "Codo", "Semicodo", "Copa Reduccion", "Universales", "Tapon", "Adaptador", "Brida", "Bushing"],
                clases: ["10", "40", "80"],
                diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "2", "2-1/2", "3", "3-1/2", "4"],
                conexiones: ["Soldeo", "NPTH", "NPTM", "Socket"],
                c_entradas: ["NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo", "Socket"],
                c_salidas: ["NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo", "Socket"]
            },
            "Bronce": {
                tipos: ["Union", "Tee", "Tee Red Central", "Tee Red Lateral", "Codo", "Semicodo", "Copa Reduccion", "Universales", "Tapon", "Adaptador", "Bushing", "Brida"],
                clases: [], // No tiene clases, se agregarán para brida.
                diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "2", "2-1/2", "3", "3-1/2", "4"],
                conexiones: ["Soldeo", "NPTH", "NPTM"],
                c_entradas: ["H-M", "H-K", "H-L", "M-M", "M-K", "M-L", "H-10", "H-40", "H-80", "M-10", "M-40", "M-80", "NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo"],
                c_salidas: ["H-M", "H-K", "H-L", "M-M", "M-K", "M-L", "H-10", "H-40", "H-80", "M-10", "M-40", "M-80", "NPTH", "NPTM", "BSPM", "BSPH", "DISS", "DIM", "CGA", "OD", "Soldeo"]
            },
            "PVC": {
                tipos: ["Union", "Tee", "Tee Red Central", "Tee Red Lateral", "Codo", "Semicodo", "Copa Reduccion", "Universales", "Tapon", "Adaptador"],
                clases: ["Presion", "Electrica", "Sanitaria", "Ventilacion"],
                diametros: ["1/8", "1/4", "3/8", "1/2", "3/4", "1", "1-1/4", "1-1/2", "2", "2-1/2", "3", "3-1/2", "4"],
                conexiones: ["Lisa", "NPTH", "NPTM"],
                c_entradas: ["Lisa", "NPTH", "NPTM"],
                c_salidas: ["Lisa", "NPTH", "NPTM"]
            }
        };

        // Generar mapeo de descripciones a códigos para accesorios
        let codigoCounterAccesorios = 144; // Comenzando desde IYR0144 como en tu ejemplo
        const descripcionToCodigoAccesorios = {};
        const descripcionesDisponiblesAccesorios = [];

        for (const material in materialOptionsAccesorios) {
            const tipos = materialOptionsAccesorios[material].tipos;
            const clases = materialOptionsAccesorios[material].clases;
            const diametros = materialOptionsAccesorios[material].diametros;
            const conexiones = materialOptionsAccesorios[material].conexiones;
            
            const materialSinEspacios = material.replace(/\s+/g, '');
            
            for (const tipo of tipos) {
                // Manejo especial para Brida
                if (tipo === "Brida" && (material === "Acero Inoxidable" || material === "Acero Carbon" || material === "Bronce")) {
                    const clasesBrida = ["150psi", "300psi", "3000psi"];
                    for (const clase of clasesBrida) {
                        for (const diametro of diametros) {
                            for (const conexion of conexiones) {
                                const descripcion = `${tipo}${materialSinEspacios}${clase}${diametro}${conexion}`;
                                const codigo = "IYR" + codigoCounterAccesorios.toString().padStart(4, '0');
                                
                                descripcionToCodigoAccesorios[descripcion] = codigo;
                                descripcionesDisponiblesAccesorios.push(descripcion);
                                codigoCounterAccesorios++;
                            }
                        }
                    }
                } 
                // Manejo para Bronce (sin clases excepto para Brida)
                else if (material === "Bronce") {
                    for (const diametro of diametros) {
                        for (const conexion of conexiones) {
                            const descripcion = `${tipo}${materialSinEspacios}${diametro}${conexion}`;
                            const codigo = "IYR" + codigoCounterAccesorios.toString().padStart(4, '0');
                            
                            descripcionToCodigoAccesorios[descripcion] = codigo;
                            descripcionesDisponiblesAccesorios.push(descripcion);
                            codigoCounterAccesorios++;
                        }
                    }
                }
                // Manejo normal para otros materiales
                else {
                    for (const clase of clases) {
                        // Formatear la clase según las reglas
                        let claseFormateada = clase;
                        if (["M", "K", "L"].includes(clase)) {
                            claseFormateada = `Tipo${clase}`;
                        } else if (["10", "40", "80"].includes(clase)) {
                            claseFormateada = `Sch${clase}`;
                        }
                        // Los demás tipos (ej: "Presión") se quedan igual
                        
                        for (const diametro of diametros) {
                            for (const conexion of conexiones) {
                                const descripcion = `${tipo}${materialSinEspacios}${claseFormateada}${diametro}${conexion}`;
                                const codigo = "IYR" + codigoCounterAccesorios.toString().padStart(4, '0');
                                
                                descripcionToCodigoAccesorios[descripcion] = codigo;
                                descripcionesDisponiblesAccesorios.push(descripcion);
                                codigoCounterAccesorios++;
                            }
                        }
                    }
                }
            }
        }

        // Variable para almacenar el item actual de accesorios
        let itemActualAccesorio = null;
        let chartAccesorios;

        // ---------------------------------------------------------------------------
        // Funciones principales para accesorios
        // ---------------------------------------------------------------------------
        function loadAccesorios() {
            const tableContent = `
                <div class="section-title vertical-title">Accesorios</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descripción</th>
                                <th>Ubicación</th>
                                <th>Cantidad</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generarFilaConsultaAccesorios()}
                        </tbody>
                    </table>
                    <div class="export-button-container">
                        <button id="btnExportarAccesorios">Exportar a Excel</button>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Gráfica de Consulta</h3>
                    <canvas id="accesoriosChart"></canvas>
                </div>
            `;

            document.getElementById('dynamicContent').innerHTML = tableContent;

            // Configurar eventos
            configurarEventosAccesorios();
            
            // Inicializar gráfica (oculta al inicio)
            document.getElementById('accesoriosChart').style.display = 'none';
        }

        function generarFilaConsultaAccesorios() {
            return `
                <tr class="fila-consulta">
                    <td id="codigoGeneradoAccesorio"></td>
                    <td>
                        <input type="text" id="inputDescripcionAccesorio" 
                            placeholder="Buscar accesorio..." 
                            list="listaAccesorios" autocomplete="off">
                        <datalist id="listaAccesorios">
                            ${descripcionesDisponiblesAccesorios.map(desc => 
                                `<option value="${desc}">${desc}</option>`).join('')}
                        </datalist>
                    </td>
                    <td><input type="text" id="inputUbicacionAccesorio" placeholder="Ubicación" value="Bogotá"></td>
                    <td id="cantidadCellAccesorio"><input type="number" id="inputCantidadAccesorio" placeholder="Cantidad" min="0" value="0" onchange="actualizarEstadoStockAccesorios()"></td>
                    <td><input type="number" id="inputValorAccesorio" placeholder="Valor" min="0" step="0.01"></td>
                </tr>
            `;
        }

        function actualizarEstadoStockAccesorios() {
            const cantidadInput = document.getElementById('inputCantidadAccesorio');
            const cantidadCell = document.getElementById('cantidadCellAccesorio');
            const valor = parseFloat(cantidadInput.value) || 0;
            
            if (valor === 0) {
                cantidadCell.innerHTML = `
                    <span class="no-stock" onclick="restaurarInputCantidadAccesorios()">No Stock</span>
                    <input type="number" id="inputCantidadAccesorio" value="0" min="0" style="display:none;">
                `;
            } else {
                cantidadCell.innerHTML = `<input type="number" id="inputCantidadAccesorio" placeholder="Cantidad" min="0" value="${valor}" onchange="actualizarEstadoStockAccesorios()">`;
            }
            
            // Actualizar el objeto itemActualAccesorio si existe
            if (itemActualAccesorio) {
                itemActualAccesorio.cantidad = valor;
                actualizarGraficaAccesorios();
            }
        }

        function restaurarInputCantidadAccesorios() {
            const cantidadCell = document.getElementById('cantidadCellAccesorio');
            cantidadCell.innerHTML = `<input type="number" id="inputCantidadAccesorio" placeholder="Cantidad" min="0" value="0" onchange="actualizarEstadoStockAccesorios()">`;
            document.getElementById('inputCantidadAccesorio').focus();
        }

        function configurarEventosAccesorios() {
            const inputDesc = document.getElementById('inputDescripcionAccesorio');
            
            inputDesc.addEventListener('input', function() {
                // Restaurar el input de cantidad al cambiar descripción
                const cantidadCell = document.getElementById('cantidadCellAccesorio');
                cantidadCell.innerHTML = `<input type="number" id="inputCantidadAccesorio" placeholder="Cantidad" min="0" value="0" onchange="actualizarEstadoStockAccesorios()">`;
                
                const descripcion = this.value;
                const codigo = descripcionToCodigoAccesorios[descripcion];
                document.getElementById('codigoGeneradoAccesorio').textContent = codigo || '';
                
                if (codigo) {
                    itemActualAccesorio = {
                        codigo: codigo,
                        descripcion: descripcion,
                        ubicacion: document.getElementById('inputUbicacionAccesorio').value || 'Bogotá',
                        cantidad: 0, // Iniciar en 0
                        valor: parseFloat(document.getElementById('inputValorAccesorio').value) || 0
                    };
                    actualizarGraficaAccesorios();
                }
            });

            // Actualizar datos cuando cambian otros campos
            ['inputUbicacionAccesorio', 'inputValorAccesorio'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (itemActualAccesorio) {
                        itemActualAccesorio.ubicacion = document.getElementById('inputUbicacionAccesorio').value;
                        itemActualAccesorio.valor = parseFloat(document.getElementById('inputValorAccesorio').value) || 0;
                        actualizarGraficaAccesorios();
                    }
                });
            });
            
            // Configurar botón de exportar
            document.getElementById('btnExportarAccesorios').addEventListener('click', exportarAExcelAccesorios);
            
            // Verificar estado inicial del stock
            actualizarEstadoStockAccesorios();
        }

        function actualizarGraficaAccesorios() {
            if (!itemActualAccesorio) {
                document.getElementById('accesoriosChart').style.display = 'none';
                return;
            }
            
            const ctx = document.getElementById('accesoriosChart').getContext('2d');
            ctx.canvas.style.display = 'block';
            
            // Asegurar que el canvas tenga el tamaño correcto
            ctx.canvas.width = ctx.canvas.offsetWidth;
            ctx.canvas.height = 300; // Altura fija
            
            if (chartAccesorios) {
                chartAccesorios.destroy();
            }
            
            chartAccesorios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [itemActualAccesorio.descripcion],
                    datasets: [{
                        label: 'Cantidad',
                        data: [itemActualAccesorio.cantidad],
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        },
                        y: { 
                            ticks: { 
                                autoSkip: false,
                                font: {
                                    size: 12
                                }
                            } 
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: () => {
                                    return `Código: ${itemActualAccesorio.codigo}\nValor: $${itemActualAccesorio.valor.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    }
                }
            });
        }

        function exportarAExcelAccesorios() {
            if (!itemActualAccesorio) {
                alert("No hay datos para exportar");
                return;
            }
            
            // Obtener el valor de cantidad (puede estar oculto como "No Stock")
            const cantidadInput = document.getElementById('inputCantidadAccesorio');
            const cantidad = parseFloat(cantidadInput.value) || 0;
            
            // Crear un objeto con los datos a exportar
            const datos = [{
                'Código': itemActualAccesorio.codigo,
                'Descripción': itemActualAccesorio.descripcion,
                'Ubicación': itemActualAccesorio.ubicacion || 'Bogotá',
                'Cantidad': cantidad === 0 ? 'No Stock' : cantidad,
                'Valor': itemActualAccesorio.valor
            }];
            
            // Convertir a CSV
            const csvRows = [];
            const headers = Object.keys(datos[0]);
            csvRows.push(headers.join(','));
            
            for (const row of datos) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // Crear enlace de descarga
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `accesorio_${itemActualAccesorio.codigo}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', function() {
            // Puedes cargar tuberías o accesorios según necesites
            // loadTuberia();
            loadAccesorios();
        });



        // ================================================================================
        // CREACION TABLA DE PROYECTOS ADD/EDIT/UPDATE/DOWLOAD/DELETE
        // ================================================================================

        // Constantes.
        const PROJECT_ID_PREFIX = 'OT-';
        const ADDITION_ID_PREFIX = 'AD-';
        let proyectosData = [];
        let proyectoEditandoId = null; // Variable para almacenar el ID del proyecto que se está editando

        // Campos editables para proyectos principales
        const MAIN_PROJECT_EDITABLE_FIELDS = ['descripcion', 'encargado', 'estado'];

        // Campos editables para adiciones
        const ADDITION_EDITABLE_FIELDS = ['Proyecto', 'descripcion', 'ubicacion', 'fechaInicio', 'fechaFin', 'encargado', 'estado', 'presupuesto'];

        // ---------------------------------------------------------------------------
        // Funciones de Utilidad
        // ---------------------------------------------------------------------------

        function generateId(prefix) {
            return prefix + Math.floor(Math.random() * 10000);
        }

        // ---------------------------------------------------------------------------
        // Funciones de Interfaz de Usuario (UI)
        // ---------------------------------------------------------------------------

        function renderTable() {
            const dynamicContent = document.getElementById('dynamicContent');
            const tableHeaders = `
                <tr>
                    <th></th> <!-- Columna para el icono del ojo -->
                    <th>ID</th>
                    <th>Proyecto</th>
                    <th>Descripción</th>
                    <th>Ubicación</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Fin</th>
                    <th>Encargado</th>
                    <th>Estado</th>
                    <th>Presupuesto</th>
                    <th>Acciones</th>
                </tr>
            `;

            function renderRow(proyecto) {
                let actionIcons = '';

                if (proyecto.isAddition) {
                    actionIcons = `
                        <i class="fas fa-edit edit-project" data-id="${proyecto.id}" title="Editar"></i>
                        <i class="fas fa-trash delete-project" data-id="${proyecto.id}" title="Eliminar"></i>
                    `;
                } else {
                    actionIcons = `
                        <i class="fas fa-edit edit-project" data-id="${proyecto.id}" title="Editar"></i>
                        <i class="fas fa-plus-square add-addition" data-id="${proyecto.id}" title="Adición"></i>
                        <i class="fas fa-file-pdf load-pdf" data-id="${proyecto.id}" title="Cargar PDF"></i>
                        <i class="fas fa-download download-project" data-id="${proyecto.id}" title="Descargar"></i>
                        <i class="fas fa-trash delete-project" data-id="${proyecto.id}" title="Eliminar"></i>
                    `;
                }

                // Determinar si la fila debe tener la clase "addition-row"
                const rowClass = proyecto.isAddition ? 'project-row addition-row' : 'project-row';

                // Agregar el icono del ojo si es el proyecto principal y tiene adiciones
                let eyeIcon = '';
                if (!proyecto.isAddition && proyectosData.some(p => p.parentId === proyecto.id)) {
                    eyeIcon = `<i class="fas fa-eye toggle-additions" data-project-id="${proyecto.id}" title="Mostrar/Ocultar Adiciones"></i>`;
                }

                return `
                    <tr class="${rowClass}" data-id="${proyecto.id}" data-parent-id="${proyecto.parentId || ''}">
                        <td class="eye-icon-cell">${eyeIcon}</td>
                        <td>${proyecto.id}</td>
                        <td>${proyecto.nombre}</td>
                        <td>${proyecto.descripcion}</td>
                        <td>${proyecto.ubicacion}</td>
                        <td>${proyecto.fechaInicio}</td>
                        <td>${proyecto.fechaFin}</td>
                        <td>${proyecto.encargado}</td>
                        <td>${proyecto.estado}</td>
                        <td>${proyecto.presupuesto}</td>
                        <td class="action-icons">
                            ${actionIcons}
                        </td>
                    </tr>
                `;
            }

            function renderProyectosRecursivamente(proyectos, parentId = null) {
                let html = '';
                const proyectosFiltrados = proyectos.filter(proyecto => proyecto.parentId === parentId);

                proyectosFiltrados.forEach(proyecto => {
                    html += renderRow(proyecto);
                    html += renderProyectosRecursivamente(proyectos, proyecto.id); // Llamada recursiva para las adiciones
                });

                return html;
            }

            dynamicContent.innerHTML = `
                <h2 class="vertical-title">Proyectos</h2>
                <div class="table-container">
                    <table>
                        <thead>${tableHeaders}</thead>
                        <tbody>${renderProyectosRecursivamente(proyectosData)}</tbody>
                    </table>
                    <button id="createProjectButton">Crear Proyecto</button>
                </div>
            `;
        }

        function assignEventListeners() {
            // **DELEGACIÓN DE EVENTOS**
            const tableBody = document.querySelector('#dynamicContent table tbody');
            if (tableBody) {
                tableBody.addEventListener('click', function(event) {
                    const target = event.target;
                    const projectId = target.dataset.id;

                    if (target.classList.contains('edit-project')) {
                        editProject(projectId);
                    } else if (target.classList.contains('add-addition')) {
                        addAddition(projectId);
                    } else if (target.classList.contains('load-pdf')) {
                        loadPDF(projectId);
                    } else if (target.classList.contains('download-project')) {
                        downloadProject(projectId);
                    } else if (target.classList.contains('delete-project')) {
                        proyectoEditandoId = projectId;
                        openConfirmModal();
                    }
                    // Delegación de evento para el toggle de adiciones
                    else if (target.classList.contains('toggle-additions')) {
                        const parentProjectId = target.dataset.projectId;
                        toggleAdditions(parentProjectId);
                    }
                });
            }
            // Crear proyecto
            document.getElementById('createProjectButton').addEventListener('click', createProject);

            // Cerrar modal con la "X"
            document.querySelector('.close').addEventListener('click', closeModal);

            // Evento para confirmar la eliminación
            document.getElementById('confirmDelete').addEventListener('click', () => {
                deleteProjectAndAdditions(proyectoEditandoId);
                closeConfirmModal();
                loadProyectos();
            });

            // Evento para cancelar la eliminación
            document.getElementById('cancelDelete').addEventListener('click', closeConfirmModal);
        }

        function toggleAdditions(projectId) {
            // Encuentra todas las filas de adición para el proyecto principal
            const additionRows = document.querySelectorAll(`.project-row[data-parent-id="${projectId}"]`);
            additionRows.forEach(row => {
                row.classList.toggle('show-additions'); // Cambia la visibilidad
            });
        }

        function loadProyectos() {
            renderTable();
            assignEventListeners();
        }

        // ---------------------------------------------------------------------------
        // Funciones Modales
        // ---------------------------------------------------------------------------

        function openModal(title) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('projectModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('projectModal').style.display = 'none';
            proyectoEditandoId = null; // Restablecer proyectoEditandoId al cerrar el modal
        }

        function openConfirmModal() {
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // ---------------------------------------------------------------------------
        // Funciones de CRUD (Crear, Leer, Actualizar, Eliminar) - Proyectos
        // ---------------------------------------------------------------------------

        function createProject() {
            proyectoEditandoId = null;
            openModal("Crear Proyecto");
            const projectForm = document.getElementById('projectForm');
            projectForm.reset();

            const projectIdField = document.getElementById('projectId');
            projectIdField.value = generateId(PROJECT_ID_PREFIX);
            projectIdField.disabled = true; // Habilitar la edición del ID

            //Habilitar el resto de los campos
            document.getElementById('projectId').disabled = false;
            document.getElementById('projectName').disabled = false;
            document.getElementById('projectDescription').disabled = false;
            document.getElementById('projectLocation').disabled = false;
            document.getElementById('projectStartDate').disabled = false;
            document.getElementById('projectEndDate').disabled = false;
            document.getElementById('projectManager').disabled = false;
            document.getElementById('projectStatus').disabled = false;
            document.getElementById('projectBudget').disabled = false;

            projectForm.dataset.mode = 'create'; // Indica que estamos en modo de creación
        }

        function editProject(projectId) {
            proyectoEditandoId = projectId; //SETEAR EL ID DEL PROYECTO A EDITAR
            const proyecto = proyectosData.find(p => p.id === projectId);

            if (!proyecto) {
                console.error(`Proyecto con ID ${projectId} no encontrado`);
                return;
            }

            openModal("Editar Proyecto");
            const projectForm = document.getElementById('projectForm');

            document.getElementById('projectId').value = proyecto.id;
            document.getElementById('projectName').value = proyecto.nombre;
            document.getElementById('projectDescription').value = proyecto.descripcion;
            document.getElementById('projectLocation').value = proyecto.ubicacion;
            document.getElementById('projectStartDate').value = proyecto.fechaInicio;
            document.getElementById('projectEndDate').value = proyecto.fechaFin;
            document.getElementById('projectManager').value = proyecto.encargado;
            document.getElementById('projectStatus').value = proyecto.estado;
            document.getElementById('projectBudget').value = proyecto.presupuesto;

            // Deshabilitar campos no editables
            document.getElementById('projectId').disabled = true;
            document.getElementById('projectName').disabled = true;
            document.getElementById('projectLocation').disabled = true;
            document.getElementById('projectStartDate').disabled = true;
            document.getElementById('projectEndDate').disabled = true;
            document.getElementById('projectBudget').disabled = true;

            // Habilitar solo los campos editables
            document.getElementById('projectDescription').disabled = false;
            document.getElementById('projectManager').disabled = false;
            document.getElementById('projectStatus').disabled = false;

            // Establecer el modo del formulario
            projectForm.dataset.mode = 'edit';
        }

        function addAddition(projectId) {
            proyectoEditandoId = null;
            openModal("Adición a Proyecto");

            const projectForm = document.getElementById('projectForm');
            projectForm.reset();
            const projectIdField = document.getElementById('projectId');

            const newId = generateId(PROJECT_ID_PREFIX); // Genera ID con OT-
            projectIdField.value = newId;
            projectIdField.dataset.parentId = projectId; // Almacena el ID del padre
            projectIdField.disabled = false; // Habilitar la edición del ID

            // Habilitar todos los campos
            document.getElementById('projectName').disabled = false;
            document.getElementById('projectDescription').disabled = false;
            document.getElementById('projectLocation').disabled = false;
            document.getElementById('projectStartDate').disabled = false;
            document.getElementById('projectEndDate').disabled = false;
            document.getElementById('projectManager').disabled = false;
            document.getElementById('projectStatus').disabled = false;
            document.getElementById('projectBudget').disabled = false;

            // Establecer el modo del formulario
            projectForm.dataset.mode = 'add';
        }

        function saveProject(event) {
            event.preventDefault();

            const projectForm = document.getElementById('projectForm');

            const projectData = {
                id: document.getElementById('projectId').value,
                nombre: document.getElementById('projectName').value,
                descripcion: document.getElementById('projectDescription').value,
                ubicacion: document.getElementById('projectLocation').value,
                fechaInicio: document.getElementById('projectStartDate').value,
                fechaFin: document.getElementById('projectEndDate').value,
                encargado: document.getElementById('projectManager').value,
                estado: document.getElementById('projectStatus').value,
                presupuesto: document.getElementById('projectBudget').value,
                parentId: document.getElementById('projectId').dataset.parentId || null,
                isAddition: projectForm.dataset.mode === 'add'
            };
            const index = proyectosData.findIndex(p => p.id === proyectoEditandoId);

            if (index !== -1) {
                const existingProject = proyectosData[index];

                // Update only the allowed fields
                if (existingProject.isAddition) {
                    ADDITION_EDITABLE_FIELDS.forEach(field => {
                        existingProject[field] = projectData[field];
                    });
                } else {
                    MAIN_PROJECT_EDITABLE_FIELDS.forEach(field => {
                        existingProject[field] = projectData[field];
                    });
                }

                proyectosData[index] = { ...existingProject }; // Use the updated existing project
            } else {
                // Creating a new project or addition
                proyectosData.push(projectData);
            }

            closeModal();
            loadProyectos();

            // Restablecer proyectoEditandoId a null después de guardar
            proyectoEditandoId = null;
        }

        function deleteProjectAndAdditions(projectId) {
            // Eliminar el proyecto actual
            proyectosData = proyectosData.filter(p => p.id !== projectId);

            // Encontrar y eliminar adiciones del proyecto (recursivamente)
            const additionsToDelete = proyectosData.filter(p => p.parentId === projectId).map(p => p.id);
            additionsToDelete.forEach(addId => deleteProjectAndAdditions(addId));
        }

        // ---------------------------------------------------------------------------
        // Funciones de  Descargar
        // ---------------------------------------------------------------------------
        
        function loadPDF(projectId) {
            const proyecto = proyectosData.find(p => p.id === projectId);
            if (proyecto) {
                // Crear un input de tipo file dinámicamente
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/pdf'; // Aceptar solo archivos PDF
        
                // Simular un clic en el input para abrir el diálogo de selección de archivos
                input.click();
        
                // Listener para el evento 'change' del input
                input.addEventListener('change', function(event) {
                    const file = event.target.files[0]; // Obtener el archivo seleccionado
        
                    if (file) {
                        // Aquí puedes realizar acciones con el archivo PDF, como subirlo a un servidor,
                        // previsualizarlo, etc.
                        console.log('Archivo PDF seleccionado:', file.name);
                        console.log('Tamaño del archivo:', file.size, 'bytes');
                        console.log('Tipo de archivo:', file.type);
        
                        // Ejemplo de cómo podrías leer el contenido del archivo (opcional):
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // e.target.result contiene el contenido del archivo como un Data URL
                            // console.log('Contenido del archivo:', e.target.result);
                            // Puedes usar este Data URL para previsualizar el PDF en un iframe o canvas
                        }
                        reader.readAsDataURL(file); // Lee el archivo como Data URL
        
                        // TODO: Implementar la lógica para guardar la referencia al archivo PDF
                        //       (por ejemplo, guardar la URL en la propiedad del proyecto)
                        // proyecto.pdfUrl = 'URL_DEL_ARCHIVO_SUBIDO';
                    }
                });
            }
        }

        function downloadProject(projectId) {
            const proyecto = proyectosData.find(p => p.id === projectId);
            if (proyecto) {
                const blob = new Blob([JSON.stringify(proyecto, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `proyecto_${proyecto.id}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // ---------------------------------------------------------------------------
        // Inicialización
        // ---------------------------------------------------------------------------

        // Cargar proyectos al hacer clic en el enlace
        document.getElementById('proyectosLink').addEventListener('click', function(event) {
            event.preventDefault();
            loadProyectos();
        });

        // Evento para el formulario de proyecto (guardar)
        document.getElementById('projectForm').addEventListener('submit', saveProject);

        // Carga inicial de proyectos
        loadProyectos();


        // ================================================================================
        // REQUISICION 
        // ================================================================================

        // Datos de ejemplo para Requisición (Se usarán solo para inicializar la interfaz)
        //  IMPORTANTE: Cambiar a array vacío para que no aparezcan datos de ejemplo
        let requisicionData = [];

        // Datos de ejemplo para el historial
        let historyData = [];

        // Función para limpiar el contenido dinámico
        function clearDynamicContent() {
            const dynamicContent = document.getElementById('dynamicContent');
            if (dynamicContent) {
                dynamicContent.innerHTML = '';
            }
        }

        // ================================================================================
        // CARGA INICIAL DEL MÓDULO
        // ================================================================================

        // Función para cargar el módulo de requisición con pantalla inicial
        function loadRequisicionModule() {
            clearDynamicContent();

            const dynamicContent = document.getElementById('dynamicContent');
            if (!dynamicContent) {
                console.error('No se encontró el elemento con id "dynamicContent"');
                return;
            }

            // Pantalla de inicio con dos opciones principales
            dynamicContent.innerHTML = `
                <div class="requisicion-module">
                    <div class="welcome-screen">
                        <div class="welcome-header">
                            <h1><i class="fas fa-file-alt"></i> Módulo de Requisiciones</h1>
                            <p>Gestiona tus solicitudes de materiales y suministros</p>
                        </div>

                        <div class="options-container">
                            <div class="option-card" id="createOption">
                                <div class="card-icon">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <h3>Crear Nueva Requisición</h3>
                                <p>Inicia un nuevo formulario en blanco para solicitar materiales</p>
                                <button class="btn btn-primary">Seleccionar</button>
                            </div>

                            <div class="option-card" id="historyOption">
                                <div class="card-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <h3>Historial de Requisiciones</h3>
                                <p>Consulta y gestiona tus requisiciones anteriores</p>
                                <button class="btn btn-primary">Seleccionar</button>
                            </div>
                        </div>

                        <div class="recent-requisitions">
                            <h3><i class="fas fa-clock"></i> Requisiciones Recientes</h3>
                            <div class="recent-list" id="recentRequisitions">
                                <!-- Se cargarán las 3 últimas requisiciones -->
                            </div>
                        </div>
                    </div>

                    <!-- Sección para crear requisición (inicialmente oculta) -->
                    <div id="createRequisicionSection" style="display: none;">
                        <!-- Contenido del formulario se cargará aquí -->
                    </div>

                    <!-- Sección para el historial (inicialmente oculta) -->
                    <div id="historySection" style="display: none;">
                        <!-- Contenido del historial se cargará aquí -->
                    </div>
                </div>
            `;

            // Cargar requisiciones recientes
            loadRecentRequisitions();

            // Asignar eventos a las opciones
            document.getElementById('createOption')?.addEventListener('click', showCreateForm);
            document.getElementById('historyOption')?.addEventListener('click', showHistorySection);
        }
        // ================================================================================
        // PANTALLA PRINCIPAL - REQUISICIONES RECIENTES
        // ================================================================================

        // Función para cargar requisiciones recientes
        function loadRecentRequisitions() {
            const container = document.getElementById('recentRequisitions');
            if (!container) return;

            // Mostrar solo las 3 más recientes
            const recent = historyData.slice(0, 3);
            // Invertir el orden para mostrar las más recientes primero
            recent.reverse();

            container.innerHTML = recent.map(item => `
                <div class="recent-item">
                    <div class="recent-id">${item.id}</div>
                    <div class="recent-project">${item.proyecto}</div>
                    <div class="recent-date">${item.fecha}</div>
                    <div class="recent-status ${item.estado}">
                        ${item.estado === 'approved' ? 'Aprobado' :
                            item.estado === 'pending' ? 'Pendiente' : 'Rechazado'}
                    </div>
                    <button class="btn btn-sm btn-view" data-id="${item.id}">Ver</button>
                </div>
            `).join('');

            // Asignar eventos a los botones de ver
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function () {
                    viewRequisicion(this.getAttribute('data-id'));
                });
            });
        }

        // ================================================================================
        // PANTALLA CREAR REQUISICION
        // ================================================================================

        // Función para mostrar el formulario de creación
        function showCreateForm() {
            const welcomeScreen = document.querySelector('.welcome-screen');
            const createSection = document.getElementById('createRequisicionSection');

            if (welcomeScreen && createSection) {
                welcomeScreen.style.display = 'none';
                createSection.style.display = 'block';
                createSection.innerHTML = `
                    <div class="create-header">
                        <button class="btn btn-back" id="backToMenu">
                            <i class="fas fa-arrow-left"></i> Volver al menú
                        </button>
                    </div>

                    <div class="requisicion-form">
                        <div class="form-header">
                            <h3>SISTEMA INTEGRADO DE GESTIÓN</h3>
                            <h4>REQUISICIÓN DE BIENES Y/O SERVICIOS</h4>
                            <div class="form-header-details">
                                <span>CÓDIGO: CP-RQ-01</span>
                                <span>FECHA: <span id="currentDate"></span></span>
                                <span>VERSIÓN: 1</span>
                                <span>PÁGINA: 1 DE 1</span>
                            </div>

                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="solicitante">SOLICITA:</label>
                                <input type="text" id="solicitante" name="solicitante" placeholder="Ingrese el solicitante">
                            </div>
                            <div class="form-group">
                                <label for="proyecto">NOMBRE PROYECTO:</label>
                                <input type="text" id="proyecto" name="proyecto" placeholder="Ingrese el nombre del proyecto">
                            </div>
                            <div class="form-group">
                                <label for="numeroOrden">NÚMERO DE ORDEN:</label>
                                <input type="text" id="numeroOrden" name="numeroOrden" placeholder="Ingrese el número de orden">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="numeroRequisicion">No. DE REQUISICIÓN:</label>
                                <input type="text" id="numeroRequisicion" name="numeroRequisicion" placeholder="Ingrese el número de requisición">
                            </div>
                            <div class="form-group">
                                <label for="fechaRequisicion">FECHA DE REQUISICIÓN:</label>
                                <input type="date" id="fechaRequisicion" name="fechaRequisicion">
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>ITEM</th>
                                        <th>DESCRIPCIÓN</th>
                                        <th>UNIDAD</th>
                                        <th>FECHA NECESIDAD</th>
                                        <th>CANT. SOLICITADA</th>
                                        <th>VALOR UNITARIO</th>
                                        <th>CANT. ENTREGADA (ALMACÉN)</th>
                                        <th>VALOR ENTREGADO (ALMACÉN)</th>
                                        <th>CANT. PENDIENTE</th>
                                        <th>CANT. ENTREGADA (COMPRAS)</th>
                                        <th>VALOR ENTREGADO (COMPRAS)</th>
                                        <th>DEVOLUCIÓN</th>
                                        <th>VALOR DEVOLUCIÓN</th>
                                        <th>ACCIÓN</th>
                                    </tr>
                                </thead>
                                <tbody id="requisicionItems">
                                    <!-- Los items se cargarán dinámicamente aquí -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="6">TOTALES</td>
                                        <td id="totalEntregadoAlmacen">0</td>
                                        <td id="totalValorAlmacen">0</td>
                                        <td></td>
                                        <td id="totalEntregadoCompras">0</td>
                                        <td id="totalValorCompras">0</td>
                                        <td></td>
                                        <td id="totalValorDevolucion">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-success" id="addItemBtn">
                                    <i class="fas fa-plus"></i> Agregar Item
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="observaciones">OBSERVACIONES / RELACIÓN DE ANEXOS:</label>
                            <textarea id="observaciones" name="observaciones" placeholder="Ingrese las observaciones"></textarea>
                        </div>

                        <div class="signature-section">
                            <div class="signature-box">
                                <label>Solicitó:</label>
                                <input type="text" class="signature-field" id="solicitoNombre" placeholder="Ingrese el nombre">
                                <div class="signature-line"></div>
                                <div class="signature-position">INGENIERO DE PROYECTOS</div>
                            </div>

                            <div class="signature-box">
                                <label>Aprobó:</label>
                                <input type="text" class="signature-field" id="aproboNombre" placeholder="Ingrese el nombre">
                                <div class="signature-line"></div>
                                <div class="signature-position">SUBGERENTE DE PROYECTOS</div>
                            </div>

                            <div class="signature-box">
                                <label>Recibe:</label>
                                <input type="text" class="signature-field" id="recibeNombre" placeholder="Ingrese el nombre">
                                <div class="signature-line"></div>
                                <div class="signature-position">ANALISTA DE COMPRAS</div>
                            </div>

                            <div class="signature-box">
                                <label>Aprobó:</label>
                                <input type="text" class="signature-field" id="aproboGerenteNombre" placeholder="Ingrese el nombre">
                                <div class="signature-line"></div>
                                <div class="signature-position">GERENTE</div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-secondary" id="cancelRequisicionBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button class="btn btn-success" id="saveRequisicionBtn">
                                <i class="fas fa-check"></i> Guardar
                            </button>
                        </div>
                    </div>
                `;

                // Inicializar el formulario
                initializeRequisicionForm();
            }
        }

        // ================================================================================
        // PANTALLA HISTORIAL DE REQUISICIONES
        // ================================================================================

        // Función para mostrar la sección de historial
        function showHistorySection() {
            const welcomeScreen = document.querySelector('.welcome-screen');
            const historySection = document.getElementById('historySection');

            if (welcomeScreen && historySection) {
                welcomeScreen.style.display = 'none';
                historySection.style.display = 'block';
                historySection.innerHTML = `
                    <div class="history-header">
                        <button class="btn btn-back" id="backToMenuFromHistory">
                            <i class="fas fa-arrow-left"></i> Volver al menú
                        </button>
                        <h2><i class="fas fa-history"></i> Historial de Requisiciones</h2>
                        <div class="header-actions">
                            <button class="btn btn-primary" id="exportHistoryBtn">
                                <i class="fas fa-file-export"></i> Exportar
                            </button>
                        </div>
                    </div>

                    <div class="history-container">
                        <div class="history-filters">
                            <div class="filter-group">
                                <label for="filterDateFrom">Desde:</label>
                                <input type="date" id="filterDateFrom" name="filterDateFrom">
                            </div>
                            <div class="filter-group">
                                <label for="filterDateTo">Hasta:</label>
                                <input type="date" id="filterDateTo" name="filterDateTo">
                            </div>
                            <div class="filter-group">
                                <label for="filterStatus">Estado:</label>
                                <select id="filterStatus" name="filterStatus">
                                    <option value="all">Todos</option>
                                    <option value="pending">Pendiente</option>
                                    <option value="approved">Aprobado</option>
                                    <option value="rejected">Rechazado</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="filterProject">Proyecto:</label>
                                <input type="text" id="filterProject" name="filterProject" placeholder="Buscar proyecto...">
                            </div>
                            <button class="btn btn-primary" id="filterHistoryBtn">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                            <button class="btn btn-secondary" id="resetFiltersBtn">
                                <i class="fas fa-undo"></i> Limpiar
                            </button>
                        </div>

                        <div class="history-stats">
                            <div class="stat-card total">
                                <h4>Total</h4>
                                <p>${historyData.length}</p>
                            </div>
                            <div class="stat-card approved">
                                <h4>Aprobadas</h4>
                                <p>${historyData.filter(item => item.estado === 'approved').length}</p>
                            </div>
                            <div class="stat-card pending">
                                <h4>Pendientes</h4>
                                <p>${historyData.filter(item => item.estado === 'pending').length}</p>
                            </div>
                            <div class="stat-card rejected">
                                <h4>Rechazadas</h4>
                                <p>${historyData.filter(item => item.estado === 'rejected').length}</p>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>N° REQUISICIÓN</th>
                                        <th>FECHA</th>
                                        <th>SOLICITANTE</th>
                                        <th>PROYECTO</th>
                                        <th>ITEMS</th>
                                        <th>ESTADO</th>
                                        <th>ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- El historial se cargará dinámicamente aquí -->
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination-controls">
                            <button class="btn btn-secondary" disabled>
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span>Página 1 de 1</span>
                            <button class="btn btn-secondary" disabled>
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Cargar datos del historial
                loadHistoryData();

                // Asignar eventos
                document.getElementById('backToMenuFromHistory')?.addEventListener('click', backToMenu);
                document.getElementById('exportHistoryBtn')?.addEventListener('click', exportHistory);
                document.getElementById('filterHistoryBtn')?.addEventListener('click', filterHistory);
                document.getElementById('resetFiltersBtn')?.addEventListener('click', resetFilters);
            }
        }


        // ================================================================================
        // FUNCIONES GENERICAS
        // ================================================================================

        // Función para volver al menú principal
        function backToMenu() {
            const welcomeScreen = document.querySelector('.welcome-screen');
            const createSection = document.getElementById('createRequisicionSection');
            const historySection = document.getElementById('historySection');

            if (welcomeScreen && createSection && historySection) {
                welcomeScreen.style.display = 'block';
                createSection.style.display = 'none';
                historySection.style.display = 'none';
                //Recargar las requisiciones recientes
                loadRecentRequisitions();
            }
        }

        // Función para inicializar el formulario de requisición
        function initializeRequisicionForm() {
            // Configurar fecha actual
            const currentDateElement = document.getElementById('currentDate');
            if (currentDateElement) {
                currentDateElement.textContent = new Date().toISOString().split('T')[0];
            }

            // Cargar items iniciales (basados en el Excel)
            loadInitialItems();

            // Asignar eventos
            document.getElementById('backToMenu')?.addEventListener('click', backToMenu);
            document.getElementById('addItemBtn')?.addEventListener('click', addNewItem);
            document.getElementById('saveRequisicionBtn')?.addEventListener('click', saveRequisition);
            document.getElementById('cancelRequisicionBtn')?.addEventListener('click', cancelRequisition);

            // Calcular totales iniciales
            calculateTotals();
        }

        // ================================================================================
        // FUNCIONES DEL FORMULARIO DE REQUISICIÓN
        // ================================================================================

        // Función para cargar items iniciales (basados en el Excel)
        function loadInitialItems() {
            const tbody = document.getElementById('requisicionItems');
            if (!tbody) return;

            tbody.innerHTML = '';
        }

        // Función para agregar nuevo item con datos específicos
        function addNewItemWithData(itemNumber, descripcion, unidad, cantidadSolicitada, cantidadEntregadaCompras) {
            const tbody = document.getElementById('requisicionItems');
            if (!tbody) return;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${itemNumber}</td>
                <td><input type="text" value="${descripcion}" class="form-control-sm"></td>
                <td><input type="text" value="${unidad}" class="form-control-sm"></td>
                <td><input type="date" class="form-control-sm"></td>
                <td><input type="text" value="${cantidadSolicitada}" class="form-control-sm" onchange="calculateRow(this)"></td>
                <td><input type="number" class="form-control-sm" onchange="calculateRow(this)"></td>
                <td><input type="number" class="form-control-sm" onchange="calculateRow(this)"></td>
                <td><input type="number" class="form-control-sm" onchange="calculateRow(this)"></td>
                <td><input type="text" class="form-control-sm" readonly></td>
                <td><input type="text" value="${cantidadEntregadaCompras}" class="form-control-sm" onchange="calculateRow(this)"></td>
                <td><input type="number" class="form-control-sm" onchange="calculateRow(this)"></td>
                <td><input type="number" class="form-control-sm" onchange="calculateRow(this)"></td>
                <td><input type="number" class="form-control-sm" readonly></td>
                <td>
                    <button class="btn btn-icon btn-danger btn-sm remove-item">
                        <i class="fas fa-minus"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);

            // Asignar evento al botón de eliminar
            row.querySelector('.remove-item').addEventListener('click', function () {
                removeItem(row);
            });

            // Calcular valores iniciales de la fila
            calculateRow(row.querySelector('input'));
        }

        // Función para calcular valores de una fila
        function calculateRow(input) {
            const row = input.closest('tr');
            if (!row) return;

            const cells = row.cells;

            // Obtener valores
            const cantidadSolicitada = parseFloat(cells[4].querySelector('input').value) || 0;
            const cantidadEntregadaAlmacen = parseFloat(cells[6].querySelector('input').value) || 0;
            const cantidadEntregadaCompras = parseFloat(cells[9].querySelector('input').value) || 0;
            const valorUnitario = parseFloat(cells[5].querySelector('input').value) || 0;
            const valorEntregadoAlmacen = parseFloat(cells[7].querySelector('input').value) || 0;
            const valorEntregadoCompras = parseFloat(cells[10].querySelector('input').value) || 0;
            const devolucion = parseFloat(cells[11].querySelector('input').value) || 0;

            // Calcular pendiente
            const cantidadPendiente = cantidadSolicitada - (cantidadEntregadaAlmacen + cantidadEntregadaCompras);
            cells[8].querySelector('input').value = cantidadPendiente >= 0 ? cantidadPendiente : 0;

            // Calcular valor de devolución (valor unitario * devolución)
            const valorDevolucion = valorUnitario * devolucion;
            cells[12].querySelector('input').value = valorDevolucion.toFixed(2);

            // Recalcular totales
            calculateTotals();
        }


        // Función para calcular totales
        function calculateTotals() {
            const rows = document.querySelectorAll('#requisicionItems tr');
            let totalEntregadoAlmacen = 0;
            let totalValorAlmacen = 0;
            let totalEntregadoCompras = 0;
            let totalValorCompras = 0;
            let totalValorDevolucion = 0;

            rows.forEach(row => {
                const cells = row.cells;

                totalEntregadoAlmacen += parseFloat(cells[6].querySelector('input').value) || 0;
                totalValorAlmacen += parseFloat(cells[7].querySelector('input').value) || 0;
                totalEntregadoCompras += parseFloat(cells[9].querySelector('input').value) || 0;
                totalValorCompras += parseFloat(cells[10].querySelector('input').value) || 0;
                totalValorDevolucion += parseFloat(cells[12].querySelector('input').value) || 0;
            });

            // Actualizar totales en el footer
            document.getElementById('totalEntregadoAlmacen').textContent = totalEntregadoAlmacen;
            document.getElementById('totalValorAlmacen').textContent = totalValorAlmacen.toFixed(2);
            document.getElementById('totalEntregadoCompras').textContent = totalEntregadoCompras;
            document.getElementById('totalValorCompras').textContent = totalValorCompras.toFixed(2);
            document.getElementById('totalValorDevolucion').textContent = totalValorDevolucion.toFixed(2);
        }

        // Función para agregar nuevo item vacío
        function addNewItem() {
            const tbody = document.getElementById('requisicionItems');
            if (!tbody) return;

            const newItemNumber = tbody.children.length + 1;
            addNewItemWithData(newItemNumber, "", "", "", ""); // Todos los campos en blanco
        }

        // Función para eliminar un item
        function removeItem(row) {
            row.remove();
            renumberItems();
            calculateTotals();
        }

        // Función para re-enumerar los items después de eliminar uno
        function renumberItems() {
            const rows = document.querySelectorAll('#requisicionItems tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        // Función para guardar la requisición
        function saveRequisition() {
            // Obtener los valores del formulario
            const solicitante = document.getElementById('solicitante').value;
            const proyecto = document.getElementById('proyecto').value;
            const numeroOrden = document.getElementById('numeroOrden').value;
            const numeroRequisicion = document.getElementById('numeroRequisicion').value;
            const fechaRequisicion = document.getElementById('fechaRequisicion').value;
            const observaciones = document.getElementById('observaciones').value;
            const solicitoNombre = document.getElementById('solicitoNombre').value;
            const aproboNombre = document.getElementById('aproboNombre').value;
            const recibeNombre = document.getElementById('recibeNombre').value;
            const aproboGerenteNombre = document.getElementById('aproboGerenteNombre').value;

            // Obtener los items de la tabla
            const items = [];
            const rows = document.querySelectorAll('#requisicionItems tr');
            rows.forEach(row => {
                const cells = row.cells;
                items.push({
                    descripcion: cells[1].querySelector('input').value,
                    unidad: cells[2].querySelector('input').value,
                    fechaNecesidad: cells[3].querySelector('input').value,
                    cantidadSolicitada: cells[4].querySelector('input').value,
                    valorUnitario: cells[5].querySelector('input').value,
                    cantidadEntregadaAlmacen: cells[6].querySelector('input').value,
                    valorEntregadoAlmacen: cells[7].querySelector('input').value,
                    cantidadPendiente: cells[8].querySelector('input').value,
                    cantidadEntregadaCompras: cells[9].querySelector('input').value,
                    valorEntregadoCompras: cells[10].querySelector('input').value,
                    devolucion: cells[11].querySelector('input').value,
                    valorDevolucion: cells[12].querySelector('input').value
                });
            });

            // Crear el objeto de la requisición
            const nuevaRequisicion = {
                id: numeroRequisicion,
                fecha: fechaRequisicion,
                solicitante: solicitante,
                proyecto: proyecto,
                items: items.length,
                estado: 'pending', // Por defecto, al crearla estará pendiente
                numeroOrden: numeroOrden,
                observaciones: observaciones,
                solicitoNombre: solicitoNombre,
                aproboNombre: aproboNombre,
                recibeNombre: recibeNombre,
                aproboGerenteNombre: aproboGerenteNombre,
                detalleItems: items // Guardar el array de items
            };

            // Agregar la nueva requisición al historial
            historyData.unshift(nuevaRequisicion); // Agrega al inicio para que sea la más reciente

            // Actualizar la pantalla de Requisiciones Recientes
            loadRecentRequisitions();

            // Mostrar mensaje de éxito
            alert('Requisición guardada correctamente con ID: ' + numeroRequisicion);

            // Volver al menú principal
            backToMenu();
        }


        // Función para cancelar la requisición
        function cancelRequisition() {
            alert('Requisición cancelada');
            // Lógica para cancelar
            backToMenu();
        }

        // ================================================================================
        // FUNCIONES DEL HISTORIAL
        // ================================================================================

        // Función para cargar los datos del historial en la tabla
        function loadHistoryData() {
            const tbody = document.getElementById('historyTableBody');
            if (!tbody) return;

            tbody.innerHTML = ''; // Limpiar la tabla

            historyData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.fecha}</td>
                    <td>${item.solicitante}</td>
                    <td>${item.proyecto}</td>
                    <td>${item.items}</td>
                    <td class="${item.estado}">${item.estado}</td>
                    <td>
                        <button class="btn btn-sm btn-edit-history" data-index="${index}" title="Editar Estado"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-export-history" data-id="${item.id}" title="Descargar Excel"><i class="fas fa-file-excel"></i></button>
                        <div id="statusContainer_${index}" style="display: inline-block;">
                           <span id="statusText_${index}">${getEstadoTexto(item.estado)}</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);

                // Asignar evento al botón de editar
                row.querySelector('.btn-edit-history').addEventListener('click', function () {
                    const index = this.getAttribute('data-index');
                    toggleStatusEdit(index);
                });

                // Asignar evento al botón de exportar
                row.querySelector('.btn-export-history').addEventListener('click', function () {
                    exportRequisicionToExcel(this.getAttribute('data-id'));
                });

            });
        }

        // Function to get the text representation of the status
        function getEstadoTexto(estado) {
            switch (estado) {
                case 'pending':
                    return 'Pendiente';
                case 'approved':
                    return 'Aprobado';
                case 'rejected':
                    return 'Rechazado';
                default:
                    return 'Desconocido';
            }
        }

        // Función para alternar la edición del estado
        function toggleStatusEdit(index) {
            const statusContainer = document.getElementById(`statusContainer_${index}`);
            const item = historyData[index];

            if (statusContainer.innerHTML.includes('<select')) {
                // Si ya está en modo edición, volver a mostrar solo el texto
                statusContainer.innerHTML = `<span id="statusText_${index}">${getEstadoTexto(item.estado)}</span>`;
            } else {
                // Si no está en modo edición, mostrar el select
                statusContainer.innerHTML = `
                    <select class="form-control-sm change-status" data-index="${index}" onchange="changeRequisitionStatus(this)">
                        <option value="pending" ${item.estado === 'pending' ? 'selected' : ''}>Pendiente</option>
                        <option value="approved" ${item.estado === 'approved' ? 'selected' : ''}>Aprobado</option>
                        <option value="rejected" ${item.estado === 'rejected' ? 'selected' : ''}>Rechazado</option>
                    </select>
                `;
            }
        }

        // Function para cambiar el estado de la requisición
        function changeRequisitionStatus(selectElement) {
            const index = selectElement.getAttribute('data-index');
            const newStatus = selectElement.value;
            historyData[index].estado = newStatus;

            // Actualizar el texto del estado
            const statusContainer = document.getElementById(`statusContainer_${index}`);
            statusContainer.innerHTML = `<span id="statusText_${index}">${getEstadoTexto(newStatus)}</span>`;

            // Desactivar el modo edición
            //toggleStatusEdit(index); //Quitar para que no se oculte

            loadHistoryData(); // Recargar la tabla para reflejar el cambio
            loadRecentRequisitions(); //Actualizar las requisiciones recientes
        }

        // Función para exportar a Excel
        function exportRequisicionToExcel(requisicionId) {
            const requisicion = historyData.find(item => item.id === requisicionId);

            if (!requisicion) {
                alert('Requisición no encontrada');
                return;
            }

            // Crear un libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([requisicion]);  // Convertir el objeto de requisición a una hoja

            // Agregar la hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, "Requisicion");

            // Generar el archivo Excel y descargarlo
            XLSX.writeFile(wb, `Requisicion_${requisicionId}.xlsx`);
        }

         // Función para ver detalles de una requisición en el historial
        function viewRequisicion(requisicionId) {
            // Buscar la requisición en el historial por su ID
            const requisicion = historyData.find(item => item.id === requisicionId);

            if (requisicion) {
                // Construir el contenido detallado de la requisición
                let detallesHTML = `
                    <h3>Detalles de la Requisición ${requisicion.id}</h3>
                    <p><strong>Fecha:</strong> ${requisicion.fecha}</p>
                    <p><strong>Solicitante:</strong> ${requisicion.solicitante}</p>
                    <p><strong>Proyecto:</strong> ${requisicion.proyecto}</p>
                    <p><strong>Número de Orden:</strong> ${requisicion.numeroOrden || 'No especificado'}</p>
                    <p><strong>Observaciones:</strong> ${requisicion.observaciones || 'Ninguna'}</p>
                    <p><strong>Solicitó:</strong> ${requisicion.solicitoNombre || 'No especificado'}</p>
                    <p><strong>Aprobó:</strong> ${requisicion.aproboNombre || 'No especificado'}</p>
                    <p><strong>Recibe:</strong> ${requisicion.recibeNombre || 'No especificado'}</p>
                    <p><strong>Aprobó (Gerente):</strong> ${requisicion.aproboGerenteNombre || 'No especificado'}</p>
                    <h4>Items:</h4>
                    <ul>
                `;

                // Iterar sobre los items de la requisición y agregarlos al HTML
                requisicion.detalleItems.forEach(item => {
                    detallesHTML += `
                        <li>
                            <strong>Descripción:</strong> ${item.descripcion},
                            <strong>Unidad:</strong> ${item.unidad},
                            <strong>Fecha Necesidad:</strong> ${item.fechaNecesidad},
                            <strong>Cantidad Solicitada:</strong> ${item.cantidadSolicitada},
                            <strong>Valor Unitario:</strong> ${item.valorUnitario},
                            <strong>Cantidad Entregada (Almacén):</strong> ${item.cantidadEntregadaAlmacen},
                            <strong>Valor Entregado (Almacén):</strong> ${item.valorEntregadoAlmacen},
                            <strong>Cantidad Pendiente:</strong> ${item.cantidadPendiente},
                            <strong>Cantidad Entregada (Compras):</strong> ${item.cantidadEntregadaCompras},
                            <strong>Valor Entregado (Compras):</strong> ${item.valorEntregadoCompras},
                            <strong>Devolución:</strong> ${item.devolucion},
                            <strong>Valor Devolución:</strong> ${item.valorDevolucion}
                        </li>
                    `;
                });

                detallesHTML += `</ul>`;

                // Mostrar los detalles en una ventana emergente o un modal
                mostrarModal(detallesHTML);
            } else {
                alert(`No se encontraron detalles para la requisición con ID: ${requisicionId}`);
            }
        }

        // Función para mostrar un modal con los detalles de la requisición
        function mostrarModal(contenido) {
            // Crear el modal dinámicamente
            const modal = document.createElement('div');
            modal.classList.add('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-button">×</span>
                    ${contenido}
                </div>
            `;

            // Agregar el modal al DOM
            document.body.appendChild(modal);

            // Mostrar el modal
            modal.style.display = 'block';

            // Asignar evento al botón de cierre
            modal.querySelector('.close-button').addEventListener('click', () => {
                modal.style.display = 'none';
                document.body.removeChild(modal); // Eliminar el modal del DOM
            });

             // Cerrar el modal al hacer clic fuera del contenido
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.removeChild(modal); // Eliminar el modal del DOM
                }
            });
        }

        // Función para filtrar el historial
        function filterHistory() {
            alert('Filtrando historial...');
            // Lógica para filtrar
        }

        // Función para guardar borrador
        function saveDraft() {
            alert('Borrador guardado correctamente');
            // Lógica para guardar borrador
        }

        // Función para exportar historial
        function exportHistory() {
            alert('Exportando historial...');
            // Lógica para exportar
        }

        // Función para resetear filtros
        function resetFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterProject').value = '';
            // Volver a cargar datos sin filtros
            loadHistoryData();
        }

        // ================================================================================
        // EVENTOS
        // ================================================================================

        // Asignar evento al elemento de la sidebar
        document.addEventListener('DOMContentLoaded', function () {
            const requisicionLink = document.getElementById('requisicionLink');

            if (requisicionLink) {
                requisicionLink.addEventListener('click', function (event) {
                    event.preventDefault();
                    loadRequisicionModule();
                });
            }

            // Asignar evento para mostrar/ocultar submenú
            const controlInventarioLink = document.getElementById('controlInventarioLink');
            if (controlInventarioLink) {
                controlInventarioLink.addEventListener('click', function (event) {
                    event.preventDefault();
                    const submenu = this.nextElementSibling;
                    if (submenu) {
                        submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                    }
                });
            }
        });


        // Asignar evento al enlace de Requisición
        document.getElementById('requisicionLink').addEventListener('click', function (event) {
            event.preventDefault();
            clearDynamicContent();
            loadRequisicionModule();
        });
        

        // ================================================================================
        // PROVEDORES
        // ================================================================================

        // Datos de ejemplo para Proveedores
        const proveedoresData = [
            { nombre: "Proveedor A", contacto: "contacto@proveedora.com", telefono: "+123456789" },
            { nombre: "Proveedor B", contacto: "contacto@proveedorb.com", telefono: "+987654321" },
            { nombre: "Proveedor C", contacto: "contacto@proveedorc.com", telefono: "+1122334455" }
        ];

        // Función para cargar la tabla de Proveedores
        function loadProveedores() {
            const tableHeaders = `
                <tr>
                    <th>Nombre</th>
                    <th>Contacto</th>
                    <th>Teléfono</th>
                </tr>
            `;

            const tableRows = proveedoresData.map(item => `
                <tr>
                    <td>${item.nombre}</td>
                    <td>${item.contacto}</td>
                    <td>${item.telefono}</td>
                </tr>
            `).join('');

            const tableContent = `
                <h2>Proveedores</h2>
                <div class="table-container">
                    <table>
                        <thead>${tableHeaders}</thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;

            document.getElementById('dynamicContent').innerHTML = tableContent;
        }

        document.getElementById('proveedoresLink').addEventListener('click', function (event) {
            event.preventDefault();
            clearDynamicContent();
            loadProveedores();
        });


        // ================================================================================
        // ALMACEN
        // ================================================================================

        // Datos de almacenes (simulados)
        const almacenData = {
        bogota: {
            id: "BOG001",
            nombre: "Almacén Bogotá",
            ubicacion: "Calle 12b Sur 52 A 77, Bogotá",
            encargado: "Carolina Pérez",
            contacto: "ingegasesyredes@gmail.com",
            productos: []
        },
        cali: {
            id: "CAL001",
            nombre: "Almacén Cali",
            ubicacion: "Avenida Siempre Viva 456, Cali",
            encargado: "Carlos Lopez",
            contacto: "carlos.lopez@almacencali.com",
            productos: []
        }
        };

        // Cargar pantalla principal
        function loadPantallaPrincipal() {
        const principalHTML = `
            <div class="alm-cards-view">
            <div class="alm-header-section">
                <h1 class="alm-main-title">
                <i class="fas fa-warehouse"></i> Gestión de Almacenes
                </h1>
                <p class="alm-subtitle">Seleccione un almacén para ver su inventario</p>
            </div>
            
            <div class="alm-card-container">
                <div class="alm-card alm-card-bogota" onclick="openAlmacenModal('BOG001')">
                <div class="alm-card-icon">
                    <i class="fas fa-building"></i>
                </div>
                <h3 class="alm-card-title">Almacén Bogotá</h3>
                <div class="alm-card-details">
                    <p><i class="fas fa-map-marker-alt"></i> ${almacenData.bogota.ubicacion}</p>
                    <p><i class="fas fa-user-tie"></i> ${almacenData.bogota.encargado}</p>
                </div>
                <div class="alm-card-footer">
                    <span class="alm-badge">${almacenData.bogota.productos.length} productos</span>
                </div>
                </div>
                
                <div class="alm-card alm-card-cali" onclick="openAlmacenModal('CAL001')">
                <div class="alm-card-icon">
                    <i class="fas fa-building"></i>
                </div>
                <h3 class="alm-card-title">Almacén Cali</h3>
                <div class="alm-card-details">
                    <p><i class="fas fa-map-marker-alt"></i> ${almacenData.cali.ubicacion}</p>
                    <p><i class="fas fa-user-tie"></i> ${almacenData.cali.encargado}</p>
                </div>
                <div class="alm-card-footer">
                    <span class="alm-badge">${almacenData.cali.productos.length} productos</span>
                </div>
                </div>
            </div>
            </div>
        `;
        
        document.getElementById('dynamicContent').innerHTML = principalHTML;
        }

        // Abrir modal de almacén
        function openAlmacenModal(almacenId) {
        const modal = document.getElementById('almacenModal');
        const modalBody = document.getElementById('almacenModalBody');
        
        const almacen = Object.values(almacenData).find(a => a.id === almacenId);
        if (!almacen) return;
        
        modalBody.innerHTML = generarContenidoModal(almacen);
        modal.classList.add('show');
        document.body.classList.add('alm-modal-open');
        }

        // Generar contenido del modal
        function generarContenidoModal(almacen) {
        return `
            <div class="alm-modal-section">
            <div class="alm-info-header">
                <div class="alm-info-icon">
                <i class="fas fa-warehouse"></i>
                </div>
                <div>
                <h3 class="alm-section-title">${almacen.nombre}</h3>
                <p class="alm-info-subtitle">${almacen.ubicacion}</p>
                </div>
            </div>
            
            <div class="alm-info-grid">
                <div class="alm-info-card">
                <i class="fas fa-user-tie alm-info-card-icon"></i>
                <h4>Encargado</h4>
                <p>${almacen.encargado}</p>
                </div>
                <div class="alm-info-card">
                <i class="fas fa-envelope alm-info-card-icon"></i>
                <h4>Contacto</h4>
                <p><a href="mailto:${almacen.contacto}">${almacen.contacto}</a></p>
                </div>
            </div>
            </div>
            
            <div class="alm-modal-section">
            <div class="alm-section-header">
                <h3 class="alm-section-title">
                <i class="fas fa-boxes"></i> Inventario
                </h3>
                <button class="alm-btn alm-btn-primary" onclick="abrirModalAgregarProducto('${almacen.id}')">
                <i class="fas fa-plus"></i> Agregar Producto
                </button>
            </div>
            
            ${generarTablaInventario(almacen.productos, almacen.id)}
            </div>
        `;
        }

        // Generar tabla de inventario
        function generarTablaInventario(productos, almacenId) {
        if (productos.length === 0) {
            return `
            <div class="alm-empty-state">
                <div class="alm-empty-icon">
                <i class="fas fa-box-open"></i>
                </div>
                <h4>No hay productos registrados</h4>
                <p>Agregue productos para comenzar a gestionar el inventario</p>
                <button class="alm-btn alm-btn-primary" onclick="abrirModalAgregarProducto('${almacenId}')">
                <i class="fas fa-plus"></i> Agregar primer producto
                </button>
            </div>
            `;
        }
        
        return `
            <div class="alm-table-responsive">
            <table class="alm-table">
                <thead>
                <tr>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                ${productos.map((producto, index) => `
                    <tr>
                    <td>${producto.codigo}</td>
                    <td>${producto.descripcion}</td>
                    <td>
                        <div class="alm-quantity-control">
                        <span class="alm-quantity-value">${producto.cantidad}</span>
                        <div class="alm-quantity-buttons">
                            <button class="alm-btn alm-btn-sm alm-btn-success" 
                                    onclick="modificarCantidad('${almacenId}', ${index}, 1)">
                            <i class="fas fa-plus"></i>
                            </button>
                            <button class="alm-btn alm-btn-sm alm-btn-warning" 
                                    onclick="modificarCantidad('${almacenId}', ${index}, -1)">
                            <i class="fas fa-minus"></i>
                            </button>
                        </div>
                        </div>
                    </td>
                    <td class="alm-actions">
                        <button class="alm-btn alm-btn-danger alm-btn-sm" 
                                onclick="eliminarProducto('${almacenId}', ${index})">
                        <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
            </div>
            
            <div class="alm-inventory-summary">
            <div class="alm-summary-item">
                <span>Total productos:</span>
                <strong>${productos.length}</strong>
            </div>
            <div class="alm-summary-item">
                <span>Total unidades:</span>
                <strong>${productos.reduce((sum, p) => sum + p.cantidad, 0)}</strong>
            </div>
            </div>
        `;
        }

        // Abrir modal para agregar producto
        function abrirModalAgregarProducto(almacenId) {
        const modal = document.getElementById('agregarProductoModal');
        const form = document.getElementById('alm-productoForm');
        
        form.innerHTML = `
            <div class="alm-form-group">
            <label class="alm-form-label">Material *</label>
            <select class="alm-form-input" id="productoMaterial" required>
                <option value="">Seleccione material...</option>
                <option value="PVC">PVC</option>
                <option value="Acero">Acero</option>
                <option value="Cobre">Cobre</option>
                <option value="Galvanizado">Galvanizado</option>
                <option value="Hierro">Hierro</option>
            </select>
            </div>
            
            <div class="alm-form-group">
            <label class="alm-form-label">Tipo *</label>
            <select class="alm-form-input" id="productoTipo" required>
                <option value="">Seleccione tipo...</option>
                <option value="Tubo">Tubo</option>
                <option value="Válvula">Válvula</option>
                <option value="Codo">Codo</option>
                <option value="Reducción">Reducción</option>
                <option value="Accesorio">Accesorio</option>
            </select>
            </div>
            
            <div class="alm-form-group">
            <label class="alm-form-label">Diámetro/Medida *</label>
            <input type="text" class="alm-form-input" id="productoDiametro" required>
            </div>
            
            <div class="alm-form-group">
            <label class="alm-form-label">Cantidad *</label>
            <input type="number" class="alm-form-input" id="productoCantidad" min="1" value="1" required>
            </div>
            
            <input type="hidden" id="almacenId" value="${almacenId}">
        `;
        
        modal.classList.add('show');
        document.body.classList.add('alm-modal-open');
        }

        // Guardar nuevo producto
        function guardarNuevoProducto() {
        const form = document.getElementById('alm-productoForm');
        if (!form.reportValidity()) return;
        
        const material = document.getElementById('productoMaterial').value;
        const tipo = document.getElementById('productoTipo').value;
        const diametro = document.getElementById('productoDiametro').value;
        const cantidad = parseInt(document.getElementById('productoCantidad').value);
        const almacenId = document.getElementById('almacenId').value;
        
        // Generar código automático
        const codigo = `${material.substring(0, 3).toUpperCase()}-${tipo.substring(0, 3).toUpperCase()}-${Math.floor(100 + Math.random() * 900)}`;
        const descripcion = `${tipo} ${material} ${diametro}`;
        
        const almacenKey = Object.keys(almacenData).find(key => almacenData[key].id === almacenId);
        almacenData[almacenKey].productos.push({
            codigo, material, tipo, diametro, descripcion, cantidad
        });
        
        // Mostrar notificación
        mostrarNotificacion('success', 'Producto agregado', `El producto ${codigo} se ha agregado correctamente.`);
        
        // Cerrar modal y actualizar vista
        closeAlmModal('agregarProductoModal');
        const modalBody = document.getElementById('almacenModalBody');
        modalBody.innerHTML = generarContenidoModal(almacenData[almacenKey]);
        }

        // Modificar cantidad de producto
        function modificarCantidad(almacenId, productoIndex, cambio) {
        const almacenKey = Object.keys(almacenData).find(key => almacenData[key].id === almacenId);
        const producto = almacenData[almacenKey].productos[productoIndex];
        
        const nuevaCantidad = producto.cantidad + cambio;
        if (nuevaCantidad < 0) {
            mostrarNotificacion('error', 'Error', 'La cantidad no puede ser menor a cero');
            return;
        }
        
        producto.cantidad = nuevaCantidad;
        
        // Actualizar vista
        const quantityElements = document.querySelectorAll('.alm-quantity-value');
        if (quantityElements[productoIndex]) {
            quantityElements[productoIndex].textContent = nuevaCantidad;
        }
        
        mostrarNotificacion('success', 'Cantidad actualizada', `Cantidad de ${producto.codigo} actualizada a ${nuevaCantidad}`);
        }

        // Eliminar producto
        function eliminarProducto(almacenId, productoIndex) {
        if (!confirm('¿Está seguro que desea eliminar este producto?')) return;
        
        const almacenKey = Object.keys(almacenData).find(key => almacenData[key].id === almacenId);
        const producto = almacenData[almacenKey].productos[productoIndex];
        
        almacenData[almacenKey].productos.splice(productoIndex, 1);
        
        // Actualizar vista
        const modalBody = document.getElementById('almacenModalBody');
        modalBody.innerHTML = generarContenidoModal(almacenData[almacenKey]);
        
        mostrarNotificacion('success', 'Producto eliminado', `El producto ${producto.codigo} ha sido eliminado`);
        }

        // Exportar inventario
        function exportarInventario() {
        // Simulación de exportación
        mostrarNotificacion('info', 'Exportar inventario', 'Preparando archivo para descarga...');
        setTimeout(() => {
            mostrarNotificacion('success', 'Exportación completa', 'El inventario se ha exportado correctamente');
        }, 1500);
        }

        // Mostrar notificación
        function mostrarNotificacion(tipo, titulo, mensaje) {
        const notificacion = document.createElement('div');
        notificacion.className = `alm-notification alm-notification-${tipo}`;
        notificacion.innerHTML = `
            <div class="alm-notification-icon">
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            </div>
            <div class="alm-notification-content">
            <h4>${titulo}</h4>
            <p>${mensaje}</p>
            </div>
            <button class="alm-notification-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
            </button>
        `;
        
        document.body.appendChild(notificacion);
        setTimeout(() => notificacion.remove(), 5000);
        }

        // Cerrar modal
        function closeAlmModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('show');
        document.body.classList.remove('alm-modal-open');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
        const almacenLink = document.getElementById('almacenLink');
        if (almacenLink) {
            almacenLink.addEventListener('click', (e) => {
            e.preventDefault();
            loadPantallaPrincipal();
            });
        }
        
        loadPantallaPrincipal();
        });





        // Función para cargar la sección de Soporte
        function loadSoporte() {
            const soporteContent = `
                <h2>Soporte</h2>
                <div class="soporte-container">
                    <p>Para soporte técnico, contáctanos a través de:</p>
                    <ul>
                        <li>
                            <a href="https://wa.me/1234567890" target="_blank">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                        </li>
                        <li>
                            <a href="mailto:davidalejandro.rx@live.com">
                                <i class="fas fa-envelope"></i> davidalejandro.rx@live.com
                            </a>
                        </li>
                    </ul>
                </div>
            `;

            document.getElementById('dynamicContent').innerHTML = soporteContent;
        }

        document.getElementById('soporteLink').addEventListener('click', function (event) {
            event.preventDefault();
            clearDynamicContent();
            loadSoporte();
        });

        // Función para limpiar el contenido dinámico
        function clearDynamicContent() {
            document.getElementById('dynamicContent').innerHTML = '';
        }

    </script>


</body>

</html>